---
import type { GetStaticPaths } from 'astro';
import { Image, getImage } from 'astro:assets';
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectMetrics from '../../components/projects/ProjectMetrics.astro';
import ProjectLinks from '../../components/projects/ProjectLinks.astro';
import ProjectGallery from '../../components/projects/ProjectGallery';
import JsonLd from '../../components/seo/JsonLd.astro';
import ZoomImage from '../../components/mdx/ZoomImage.astro';

export const getStaticPaths = (async () => {
  const projects = await getCollection('projects', ({ data }) => !data.draft);
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}) satisfies GetStaticPaths;

const { project } = Astro.props;
const { title, description, coverImage, gallery, tags, links, role, dateRange, metrics } =
  project.data;
const { Content } = await render(project);
const isPortrait = coverImage.width < coverImage.height;

// Resolve cover + gallery images to plain objects for the React gallery
const allImages = [coverImage, ...gallery];
const resolvedImages = await Promise.all(
  allImages.map(async (img) => {
    const resolved = await getImage({ src: img, width: 1200 });
    return { src: resolved.src, width: resolved.attributes.width as number, height: resolved.attributes.height as number };
  })
);
---

<BaseLayout title={`${title} â€” Vladyslav Semenchenko`} description={description}>
  <Fragment slot="head">
    <JsonLd type="project" title={title} description={description} url={Astro.url.href} />
  </Fragment>
  <article class="mx-auto max-w-5xl px-4 pt-12 pb-12 sm:pt-16 sm:pb-16">
    <!-- Back link -->
    <a
      href="/projects"
      class="inline-flex items-center gap-1 text-sm text-zinc-500 transition-colors hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="m15 18-6-6 6-6" />
      </svg>
      Back to Projects
    </a>

    <!-- Header -->
    <header class="mt-8">
      {(role || dateRange) && (
        <div class="flex flex-wrap items-center gap-2 text-sm text-zinc-500 dark:text-zinc-400">
          {role && <span>{role}</span>}
          {role && dateRange && <span aria-hidden="true">&middot;</span>}
          {dateRange && <span>{dateRange}</span>}
        </div>
      )}
      <h1 class="mt-3 text-3xl font-bold tracking-tight text-zinc-900 dark:text-zinc-100 sm:text-4xl">
        {title}
      </h1>
      <div class="mt-4 flex flex-wrap gap-2">
        {tags.map((tag) => (
          <span class="rounded-full bg-accent-50 px-3 py-1 text-xs font-medium text-accent-700 dark:bg-accent-950 dark:text-accent-300">
            {tag}
          </span>
        ))}
      </div>
    </header>

    <!-- Cover image -->
    {isPortrait ? (
      <div class="mt-8 flex justify-center">
        <Image
          src={coverImage}
          alt={title}
          height={672}
          class="max-h-[70vh] w-auto rounded-xl"
        />
      </div>
    ) : (
      <Image
        src={coverImage}
        alt={title}
        width={960}
        height={504}
        class="mt-8 w-full rounded-xl object-cover"
      />
    )}

    <!-- Metrics -->
    {metrics && metrics.length > 0 && (
      <div class="mt-8">
        <ProjectMetrics metrics={metrics} />
      </div>
    )}

    <!-- Gallery -->
    {resolvedImages.length > 1 && (
      <div class="mt-8">
        <ProjectGallery images={resolvedImages} title={title} client:visible />
      </div>
    )}

    <!-- Links -->
    {links.length > 0 && (
      <div class="mt-8">
        <ProjectLinks links={links} />
      </div>
    )}

    <!-- MDX content -->
    <div class="prose prose-zinc prose-violet mt-10 max-w-none dark:prose-invert prose-headings:scroll-mt-20 prose-a:text-accent-600 dark:prose-a:text-accent-400">
      <Content components={{ img: ZoomImage }} />
    </div>
  </article>
</BaseLayout>
